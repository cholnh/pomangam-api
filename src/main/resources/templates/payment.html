<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${title}"></title>
</head>
<body>

    <button type="button" onclick="run()">pay</button>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    <script>
        /* 전역 변수 */
        var IMP = window.IMP;
        IMP.init("imp38285142");

        /* 서버에서 계산되어진 물품들의 총 금액 (프로모션, 포인트, 쿠폰할인 등 이 모두 계산되어진 최종 가격) */
        var finalAmount;
        /* 서버에서 생성되는 구매자 식별 아이디 */
        var merchant_uid;
        /* 주문 인덱스 */
        var order_idx;


        /**
         * PG 테스트 실행
         */
        function run() {
            /* 장바구니 인덱스 */
            var cartIdx = 6;
            /* 물품을 구매할 때 사용한 포인트 */
            var usingPoint = 0;
            /* 물품을 구매할 때 사용한 쿠폰의 코드 (사용 안 함 : null) */
            var usingCouponCode = null;
            /* (카드결제 : 1 / 가상계좌 : 2 / 핸드폰결제 : 3 / 카카오 페이 : 4) */
            var typePayment = 4;

            prepare(cartIdx, usingPoint, usingCouponCode, typePayment);
            pay();          // 카카오 페이 테스트 (카카오페이 결제 용)
            //payMobile();  // KG INICIS 테스트 (카드결제, 가상계좌, 핸드폰결제 용)
        }


        /**
         * PG 모듈 실행 전, 서버에 사전 정보 저장
         */
        function prepare(cartIdx, usingPoint, usingCouponCode, typePayment) {
            /* SERVER WORK */
            $.ajax({
                url : 'https://www.pomangam.com:9530/api/v1/payments/prepare',
                type : 'post',
                async : false,  // SYNC
                contentType: "application/json",
                dataType : 'json',
                data : JSON.stringify({
                    "cartIdx" : cartIdx,
                    "usingPoint" : usingPoint,
                    "usingCouponCode" : usingCouponCode,
                    "typePayment" : typePayment
                }),
                success : function(data) {
                    merchant_uid = data.merchantUid;
                    order_idx = data.idx;
                    finalAmount = data.final_amount;
                }
            });
        }

        /**
         * PG 결제 모듈 실행 (테스트) - 카카오 페이
         * @see https://www.iamport.kr/getstarted
         * @see https://github.com/iamport/iamport-manual/blob/master/%EC%9D%B8%EC%A6%9D%EA%B2%B0%EC%A0%9C/sample/kakao.md
         */
        function pay() {
            if(!merchant_uid || merchant_uid.length <= 0) {
                alert("결제실패 - 서버오류");
                return;
            }

            /* APP WORK */
            IMP.request_pay({
                pg : 'kakao',   // 카카오페이
                pay_method : 'card',
                merchant_uid : merchant_uid,
                name : '주문명:결제테스트',
                amount : finalAmount,
                buyer_email : 'iamport@siot.do',
                buyer_name : '구매자이름',
                buyer_tel : '010-1234-5678',
                buyer_addr : '서울특별시 강남구 삼성동',
                buyer_postcode : '123-456',
                m_redirect_url : 'https://www.pomangam.com:9530/api/v1/tests/payment/complete/mobile',
                app_scheme  : 'pomangamApp'

            }, function(rsp) {
                if ( rsp.success ) {
                    // var msg = '결제가 완료되었습니다.';
                    // msg += '고유ID : ' + rsp.imp_uid;
                    // msg += '상점 거래ID : ' + rsp.merchant_uid;
                    // msg += '결제 금액 : ' + rsp.paid_amount;
                    // msg += '카드 승인번호 : ' + rsp.apply_num;
                    success(rsp.imp_uid, rsp.merchant_uid);
                } else {
                    var msg = '결제에 실패하였습니다.';
                    msg += '에러내용 : ' + rsp.error_msg;
                    alert(msg);
                    fail(order_idx);
                }

            });
        }


        /**
         *  PG 결제 모듈 실행 (테스트) - KG INICIS
         *  @see https://www.iamport.kr/getstarted
         *  @see https://github.com/iamport/iamport-manual/blob/master/%EC%9D%B8%EC%A6%9D%EA%B2%B0%EC%A0%9C/sample/inicis.md
         */
        function payMobile() {
            if(!merchant_uid || merchant_uid.length <= 0) {
                alert("결제실패 - 서버오류");
                return;
            }

            /* APP WORK */
            IMP.request_pay({
                pg : 'html5_inicis',    // KG INICIS
                pay_method : 'phone',   // ( 카드결제 : 'card' / 가상계좌 : 'vbank' / 핸드폰결제 : 'phone' )
                merchant_uid : merchant_uid,
                name : '주문명:결제테스트',
                amount : finalAmount,
                buyer_email : 'iamport@siot.do',
                buyer_name : '구매자이름',
                buyer_tel : '010-1234-5678',
                buyer_addr : '서울특별시 강남구 삼성동',
                buyer_postcode : '123-456',
                m_redirect_url : 'https://www.pomangam.com:9530/api/v1/tests/payment/complete/mobile'

                // ISP모바일, 카드사 앱카드와 같이 별도의 앱이 실행된 뒤에는 원래의 앱으로 돌아오기 위해
                // Custom URL Scheme을 호출하게 되는데, 이 때 app_scheme에 지정된 URL Scheme을 호출합니다.(://는 뒤에 붙이지 않습니다)
                // app_scheme  : 'pomangamApp'

            }, function(rsp) {
                if ( rsp.success ) {
                    var msg = '결제가 완료되었습니다.';
                    msg += '고유ID : ' + rsp.imp_uid;
                    msg += '상점 거래ID : ' + rsp.merchant_uid;
                    msg += '결제 금액 : ' + rsp.paid_amount;
                    msg += '카드 승인번호 : ' + rsp.apply_num;
                    //success(rsp.imp_uid, rsp.merchant_uid);
                } else {
                    var msg = '결제에 실패하였습니다.';
                    msg += '에러내용 : ' + rsp.error_msg;
                    //fail(order_idx);
                }
                alert(msg);
            });

            /**
             * 결제 실패
             */
            function fail(orderIdx) {
                if(orderIdx) {
                    $.ajax({
                        url : 'https://www.pomangam.com:9530/api/v1/payments/'+ orderIdx +'/fail',
                        type : 'get',
                        success : function(data) {
                        }
                    });
                }
            }

            /**
             * 결제 성공
             */
            function success(imp_uid, merchant_uid) {
                $.ajax({
                    url : 'https://www.pomangam.com:9530/api/v1/payments/complete',
                    type : 'post',
                    contentType: "application/json",
                    dataType : 'json',
                    data : JSON.stringify({
                        "imp_uid" : imp_uid,
                        "merchant_uid" : merchant_uid,
                    }),
                    success : function(data) {
                    }
                });
            }
        }
    </script>
</body>
</html>